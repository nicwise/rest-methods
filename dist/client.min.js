"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),_lodash=require("lodash"),_lodash2=_interopRequireDefault(_lodash),_const=require("../const"),_bluebird=require("bluebird"),_bluebird2=_interopRequireDefault(_bluebird),_jsUtil=require("js-util"),MethodProxy=function(){function e(t){var r=arguments.length<=1||void 0===arguments[1]?[]:arguments[1];_classCallCheck(this,e),this.name=t,this.params=r}return _createClass(e,[{key:"invoke",value:function(){for(var e=this,t=arguments.length,r=Array(t),a=0;t>a;a++)r[a]=arguments[a];return new _bluebird2["default"](function(t,a){var n={method:e.name,args:_lodash2["default"].flatten(r)};_jsUtil.xhr.post("/"+_const.BASE_URL+"/invoke",n).then(function(e){t(e)})["catch"](function(e){a(e)})})}}]),e}();exports["default"]=MethodProxy,module.exports=exports["default"],Object.defineProperty(exports,"__esModule",{value:!0});var _lodash=require("lodash"),_lodash2=_interopRequireDefault(_lodash),_MethodProxy=require("./MethodProxy"),_MethodProxy2=_interopRequireDefault(_MethodProxy),_jsUtil=require("js-util"),_jsUtil2=_interopRequireDefault(_jsUtil),_bluebird=require("bluebird"),_bluebird2=_interopRequireDefault(_bluebird),_const=require("../const"),state={methods:{},queue:[],readyHandlers:new _jsUtil.Handlers};exports.state=state;var api={isReady:!1,reset:function(){this.isReady=!1,state.methods={},state.queue=[],state.readyHandlers=new _jsUtil.Handlers},onReady:function(e){return api.isReady?_lodash2["default"].isFunction(e)&&e():state.readyHandlers.push(e),this},call:function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),a=1;t>a;a++)r[a-1]=arguments[a];return this.apply(e,r)},apply:function(e){var t=arguments.length<=1||void 0===arguments[1]?[]:arguments[1];if(_lodash2["default"].isArray(t)||(t=[t]),this.isReady){var r=state.methods[e];if(!r)throw new Error("Method '"+e+"' does not exist.");return r.invoke(t)}return new _bluebird2["default"](function(r,a){state.queue.push({methodName:e,args:t,resolve:r,reject:a})})}},registerMethods=function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];if(_lodash2["default"].keys(e).forEach(function(t){state.methods[t]=new _MethodProxy2["default"](t,e[t].params)}),api.isReady=!0,state.queue.length>0){var t=_lodash2["default"].clone(state.queue);state.queue=[],t.forEach(function(e){api.apply(e.methodName,e.args).then(function(t){e.resolve(t)})["catch"](function(t){e.reject(t)})})}return void _jsUtil2["default"].delay(function(){state.readyHandlers.invoke(),state.readyHandlers=new _jsUtil.Handlers})};exports.registerMethods=registerMethods;var init=function(){return new _bluebird2["default"](function(e,t){_jsUtil2["default"].xhr.get("/"+_const.BASE_URL+"/manifest").then(function(t){registerMethods(t.methods),e()})["catch"](function(e){return t(e)})})};exports.init=init,exports["default"]=api;